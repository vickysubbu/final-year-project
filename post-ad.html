<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post Free Ad â€“ Farm Direct Connect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --green-light: #d4edda;
      --green-main: #28a745;
      --accent-yellow: #ffc107;
      --bg-gradient: linear-gradient(135deg, #e8f5e9, #ffeaa7, #fab1a0);
    }
    body {
      background: var(--bg-gradient); background-size: 400% 400%; animation: gradient-bg 15s ease infinite;
      min-height: 100vh; margin: 0;
    }
    @keyframes gradient-bg {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .card {
      border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s;
    }
    .card:hover { transform: scale(1.02); }
    .btn-success {
      background: linear-gradient(135deg, var(--green-main), var(--accent-yellow));
    }
    .preview-img {
      max-height: 350px;
      object-fit: cover;
      border-radius: 12px;
      margin-top: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .searching-text {
      color: #6c757d;
      font-style: italic;
      margin-top: 10px;
    }
    #google_translate_element { position: fixed; top: 10px; right: 10px; z-index: 1000; }
  </style>
</head>
<body>

<div id="google_translate_element"></div>

<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand text-success fw-bold" href="index.html">Farm Direct Connect</a>
    <a class="btn btn-outline-secondary" href="products.html">View My Products</a>
  </div>
</nav>

<div class="container my-5">
  <h2 class="text-center text-success mb-4">Post Your Fresh Product</h2>
  <div class="card p-4">
    <form id="ad-form">
      <div class="mb-3">
        <label class="form-label">Product Name</label>
        <input type="text" class="form-control form-control-lg" id="product-name" placeholder="e.g. Fresh Oranges" required>
        <small class="text-muted">Type the name to auto-fetch a high-quality image</small>
      </div>

      <div class="mb-3">
        <label class="form-label">Category</label>
        <select class="form-select form-select-lg" id="category" required>
          <option value="">Select Category</option>
          <option value="Vegetables">Vegetables</option>
          <option value="Fruits">Fruits</option>
          <option value="Grains">Grains</option>
          <option value="Dairy">Dairy</option>
          <option value="Others">Others</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Price</label>
        <input type="text" class="form-control form-control-lg" id="price" placeholder="e.g. â‚¹60/kg" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Location (City)</label>
        <input type="text" class="form-control form-control-lg" id="location" placeholder="e.g. Erode" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Description (Optional)</label>
        <textarea class="form-control" id="description" rows="4" placeholder="e.g. Fresh from the farm, sweet and juicy"></textarea>
      </div>

      <div class="mb-4 text-center">
        <label class="form-label d-block">Product Image</label>
        <p class="searching-text" id="image-status">Type product name above to auto-load image</p>
        <img id="image-preview" class="preview-img img-fluid" src="https://via.placeholder.com/600x400?text=No+Image+Yet" alt="Product Preview">
        <div class="mt-3">
          <small class="text-muted">Or upload your own image (overrides auto-fetch):</small>
          <input type="file" class="form-control mt-2" id="image" accept="image/*">
        </div>
      </div>

      <button type="submit" class="btn btn-success btn-lg w-100">Post Product</button>
    </form>
  </div>
</div>

<script>
let autoFetchedImage = null;

document.getElementById('product-name').addEventListener('input', async function() {
  const query = this.value.trim();
  const preview = document.getElementById('image-preview');
  const status = document.getElementById('image-status');

  if (query.length < 3) {
    status.textContent = "Type at least 3 characters to search image";
    preview.src = "https://via.placeholder.com/600x400?text=No+Image+Yet";
    autoFetchedImage = null;
    return;
  }

  status.textContent = "Searching for fresh " + query + " images...";
  preview.src = "https://via.placeholder.com/600x400?text=Searching...";

  try {
    // Using reliable codetabs.com CORS proxy (working as of Dec 2025)
    const searchUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(
      'https://www.google.com/search?q=' + encodeURIComponent(query + ' fresh farm produce india') + '&tbm=isch'
    )}`;

    const response = await fetch(searchUrl);
    const html = await response.text();

    // Extract first good image
    const imgRegex = /<img[^>]+src="([^">]+)"/g;
    let match;
    let found = false;
    while ((match = imgRegex.exec(html)) !== null) {
      const src = match[1];
      if (src.startsWith('https://') && !src.includes('google') && !src.includes('gstatic')) {
        preview.src = src;
        autoFetchedImage = src;
        status.textContent = "Image auto-fetched successfully! ðŸŽ‰";
        found = true;
        break;
      }
    }

    if (!found) {
      preview.src = "https://via.placeholder.com/600x400?text=No+Suitable+Image+Found";
      status.textContent = "No good image found. Upload one manually.";
    }
  } catch (err) {
    console.error("Image search error:", err);
    preview.src = "https://via.placeholder.com/600x400?text=Search+Failed";
    status.textContent = "Image search failed. Upload manually.";
  }
});

// Manual upload overrides auto image
document.getElementById('image').addEventListener('change', function(e) {
  if (e.target.files[0]) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      document.getElementById('image-preview').src = ev.target.result;
      autoFetchedImage = null;
      document.getElementById('image-status').textContent = "Your uploaded image";
    };
    reader.readAsDataURL(e.target.files[0]);
  }
});

// Form submission
document.getElementById('ad-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const token = localStorage.getItem('token');
  if (!token) {
    alert("Please login first");
    window.location.href = "login.html";
    return;
  }

  let imageUrl = 'https://via.placeholder.com/600x400?text=No+Image';

  const fileInput = document.getElementById('image');
  if (fileInput.files[0]) {
    imageUrl = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.readAsDataURL(fileInput.files[0]);
    });
  } else if (autoFetchedImage) {
    imageUrl = autoFetchedImage;
  }

  const product = {
    name: document.getElementById('product-name').value.trim(),
    category: document.getElementById('category').value,
    price: document.getElementById('price').value.trim(),
    description: document.getElementById('description').value.trim(),
    location: document.getElementById('location').value.trim(),
    image: imageUrl
  };

  try {
    const res = await fetch('http://localhost:5000/api/products', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(product)
    });

    const data = await res.json();

    if (res.ok) {
      alert("Product posted successfully! ðŸŽ‰");
      document.getElementById('ad-form').reset();
      document.getElementById('image-preview').src = "https://via.placeholder.com/600x400?text=No+Image+Yet";
      document.getElementById('image-status').textContent = "Type product name above to auto-load image";
      autoFetchedImage = null;
    } else {
      alert(data.msg || "Failed to post product");
    }
  } catch (err) {
    console.error(err);
    alert("Server error - is backend running?");
  }
});
</script>

<!-- Google Translate -->
<script>
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    includedLanguages: 'en,ta,kn,ml,hi,te'
  }, 'google_translate_element');
}
</script>
<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>